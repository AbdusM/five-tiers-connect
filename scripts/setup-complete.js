#!/usr/bin/env node

/**
 * Comprehensive Automated Setup for Five Tiers Connect
 * Handles all setup steps systematically
 */

const fs = require('fs');
const path = require('path');
const https = require('https');
const { execSync } = require('child_process');
require('dotenv').config({ path: path.join(__dirname, '../.env.local') });

const PROJECT_DIR = path.join(__dirname, '..');
const ENV_FILE = path.join(PROJECT_DIR, '.env.local');
const SCHEMA_FILE = path.join(PROJECT_DIR, 'supabase/schema.sql');

// Colors for output
const colors = {
  reset: '\x1b[0m',
  green: '\x1b[32m',
  yellow: '\x1b[33m',
  red: '\x1b[31m',
  blue: '\x1b[34m',
  cyan: '\x1b[36m',
};

function log(message, color = 'reset') {
  console.log(`${colors[color]}${message}${colors.reset}`);
}

function error(message) {
  log(`âŒ ${message}`, 'red');
}

function success(message) {
  log(`âœ… ${message}`, 'green');
}

function info(message) {
  log(`â„¹ï¸  ${message}`, 'blue');
}

function warning(message) {
  log(`âš ï¸  ${message}`, 'yellow');
}

function step(message) {
  log(`\nðŸ“‹ ${message}`, 'cyan');
}

// Check if Supabase CLI is available
function checkSupabaseCLI() {
  try {
    execSync('which supabase', { stdio: 'ignore' });
    return true;
  } catch {
    return false;
  }
}

// Get project ref from Supabase CLI
function getProjectRef() {
  try {
    const projectRefFile = path.join(PROJECT_DIR, 'supabase/.temp/project-ref');
    if (fs.existsSync(projectRefFile)) {
      return fs.readFileSync(projectRefFile, 'utf8').trim();
    }
  } catch {
    // Ignore
  }
  return null;
}

// Get Supabase URL from project ref
function getSupabaseUrl(projectRef) {
  return `https://${projectRef}.supabase.co`;
}

// Read or create .env.local
function setupEnvFile(projectRef) {
  step('Setting up environment variables...');

  let envVars = {};
  const supabaseUrl = projectRef ? getSupabaseUrl(projectRef) : '';

  if (fs.existsSync(ENV_FILE)) {
    const content = fs.readFileSync(ENV_FILE, 'utf8');
    content.split('\n').forEach(line => {
      const match = line.match(/^([^=]+)=(.*)$/);
      if (match && !match[1].startsWith('#')) {
        envVars[match[1].trim()] = match[2].trim();
      }
    });
    info('Found existing .env.local');
    
    // Check if all required vars are present
    if (envVars.NEXT_PUBLIC_SUPABASE_URL && envVars.NEXT_PUBLIC_SUPABASE_ANON_KEY) {
      success('All required environment variables found');
      return Promise.resolve(envVars);
    }
  }

  // Check what's missing
  const required = {
    'NEXT_PUBLIC_SUPABASE_URL': supabaseUrl || 'https://your-project.supabase.co',
    'NEXT_PUBLIC_SUPABASE_ANON_KEY': '',
  };

  const optional = {
    'SUPABASE_SERVICE_ROLE_KEY': '',
  };

  let needsUpdate = false;
  const readline = require('readline').createInterface({
    input: process.stdin,
    output: process.stdout,
  });

  return new Promise((resolve) => {
    const checkAndPrompt = (key, defaultValue, isRequired) => {
      if (envVars[key] && envVars[key] !== defaultValue) {
        return; // Already set
      }

      if (isRequired && !envVars[key]) {
        needsUpdate = true;
        const prompt = defaultValue 
          ? `Enter ${key} [${defaultValue}]: `
          : `Enter ${key}: `;
        
        readline.question(prompt, (value) => {
          envVars[key] = value || defaultValue || '';
          checkNext();
        });
        return;
      }
      checkNext();
    };

    let currentKey = null;
    const keys = Object.keys(required).concat(Object.keys(optional));
    let keyIndex = 0;

    const checkNext = () => {
      if (keyIndex < keys.length) {
        currentKey = keys[keyIndex];
        const isRequired = required.hasOwnProperty(currentKey);
        const defaultValue = required[currentKey] || optional[currentKey];
        checkAndPrompt(currentKey, defaultValue, isRequired);
        keyIndex++;
      } else {
        readline.close();
        if (needsUpdate) {
          // Write .env.local
          let content = '# Five Tiers Connect - Environment Variables\n';
          content += '# Generated by automated setup\n\n';
          
          Object.entries(envVars).forEach(([key, value]) => {
            if (value) {
              content += `${key}=${value}\n`;
            }
          });

          fs.writeFileSync(ENV_FILE, content);
          success('Created/updated .env.local');
        }
        resolve(envVars);
      }
    };

    checkNext();
  });
}

// Apply schema using Management API
async function applySchema(projectRef, serviceKey) {
  step('Applying database schema...');

  if (!serviceKey) {
    warning('Service role key not provided');
    warning('Schema will need to be applied manually');
    return false;
  }

  if (!fs.existsSync(SCHEMA_FILE)) {
    error(`Schema file not found: ${SCHEMA_FILE}`);
    return false;
  }

  const schema = fs.readFileSync(SCHEMA_FILE, 'utf8');
  const apiUrl = `https://api.supabase.com/v1/projects/${projectRef}/database/query`;

  return new Promise((resolve) => {
    const postData = JSON.stringify({ query: schema });

    const options = {
      hostname: 'api.supabase.com',
      path: `/v1/projects/${projectRef}/database/query`,
      method: 'POST',
      headers: {
        'Authorization': `Bearer ${serviceKey}`,
        'Content-Type': 'application/json',
        'Content-Length': Buffer.byteLength(postData),
      },
    };

    const req = https.request(options, (res) => {
      let data = '';

      res.on('data', (chunk) => {
        data += chunk;
      });

      res.on('end', () => {
        if (res.statusCode === 200 || res.statusCode === 201) {
          success('Schema applied successfully!');
          resolve(true);
        } else {
          warning(`API returned status ${res.statusCode}`);
          if (res.statusCode === 404) {
            warning('Management API endpoint not available');
            warning('Please apply schema manually via SQL Editor');
          } else {
            warning('Schema application failed');
            warning('Please apply schema manually via SQL Editor');
          }
          resolve(false);
        }
      });
    });

    req.on('error', (err) => {
      warning(`Request error: ${err.message}`);
      warning('Please apply schema manually via SQL Editor');
      resolve(false);
    });

    req.write(postData);
    req.end();
  });
}

// Main setup function
async function main() {
  log('\nðŸš€ Five Tiers Connect - Comprehensive Setup\n', 'cyan');
  log('='.repeat(50), 'cyan');

  // Step 1: Check Supabase CLI
  step('Checking Supabase CLI...');
  if (!checkSupabaseCLI()) {
    error('Supabase CLI not found');
    info('Install: brew install supabase/tap/supabase');
    info('Or: npm install -g supabase');
    process.exit(1);
  }
  success('Supabase CLI found');

  // Step 2: Check project link
  step('Checking project link...');
  const projectRef = getProjectRef();
  if (!projectRef) {
    error('Project not linked');
    info('Run: supabase link --project-ref your-project-ref');
    info('Or: supabase projects list (to see available projects)');
    process.exit(1);
  }
  success(`Linked to project: ${projectRef}`);

  // Step 3: Setup environment
  const envVars = await setupEnvFile(projectRef);

  // Reload env vars
  require('dotenv').config({ path: ENV_FILE });

  // Step 4: Apply schema
  const schemaApplied = await applySchema(
    projectRef,
    process.env.SUPABASE_SERVICE_ROLE_KEY
  );

  // Step 5: Summary
  log('\n' + '='.repeat(50), 'cyan');
  step('Setup Summary');
  log('='.repeat(50), 'cyan');

  success(`Project: ${projectRef}`);
  success(`URL: ${getSupabaseUrl(projectRef)}`);
  
  if (envVars.NEXT_PUBLIC_SUPABASE_ANON_KEY) {
    success('API keys configured');
  } else {
    warning('API keys need to be added to .env.local');
  }

  if (schemaApplied) {
    success('Database schema applied');
  } else {
    warning('Database schema needs manual application');
    info(`SQL Editor: ${getSupabaseUrl(projectRef)}/sql/new`);
    info(`Schema file: ${SCHEMA_FILE}`);
  }

  log('\nðŸ“ Next Steps:', 'cyan');
  if (!schemaApplied) {
    log('  1. Apply schema: Copy supabase/schema.sql to SQL Editor', 'yellow');
  }
  log('  2. Create admin user: Sign up, then change role in Supabase', 'blue');
  log('  3. Run: npm run dev', 'blue');
  log('  4. Open: http://localhost:3000', 'blue');

  log('\nâœ… Setup complete!\n', 'green');
}

// Run if called directly
if (require.main === module) {
  main().catch((err) => {
    error(err.message);
    process.exit(1);
  });
}

module.exports = { main };
